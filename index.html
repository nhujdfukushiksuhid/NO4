<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»‹è­·æ–½è¨­ æ³•å®šç ”ä¿®è¨ºæ–­ãƒ„ãƒ¼ãƒ«</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* =========================================
           1. Strict Design System [Modified for Orange Theme]
           ========================================= */
        :root {
            /* Palette: Orange (GAS Style) & Slate */
            --primary: #ff9900;       /* GAS Orange */
            --primary-hover: #e68a00; /* Darker Orange */
            --primary-ring: rgba(255, 153, 0, 0.3); /* Focus ring */
            
            --text-main: #0f172a;     /* Slate 900 */
            --text-muted: #64748b;    /* Slate 500 */
            --surface: #ffffff;
            --background: #f8fafc;    /* Slate 50 */
            --border: #e2e8f0;        /* Slate 200 */
            
            --danger: #ef4444;        /* For Ads/Warnings */
            --success: #22c55e;
            
            /* Info Box (Keep Blue for contrast or match GAS style) */
            --info-bg: #fff7ed;       /* Orange-50 */
            --info-text: #c2410c;     /* Orange-700 */

            /* Spacing & Rhythm */
            --unit: 4px;
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            
            /* Depth (Liquid Glass) */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Modern CSS Reset */
        *, *::before, *::after { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: var(--background);
            color: var(--text-main);
            line-height: 1.6;
            margin: 0;
            padding: 1rem;
            font-size: 16px; /* Prevent zoom on iOS inputs */
        }

        /* =========================================
           2. Component Styles
           ========================================= */
        
        /* Containers */
        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
        }

        /* Typography */
        h1, h2, h3 {
            color: var(--text-main);
            font-weight: 700;
            margin-top: 0;
            letter-spacing: -0.025em;
        }
        
        h1.title { font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem; }
        p.subtitle { text-align: center; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

        .text-muted { color: var(--text-muted); font-size: 0.9rem; }
        .text-center { text-align: center; }

        /* Save Guide */
        .save-guide {
            background-color: var(--info-bg);
            color: var(--info-text);
            padding: 1rem;
            text-align: center;
            border-radius: var(--radius-md);
            margin-bottom: 1.5rem;
            border: 1px solid #fed7aa; /* Orange-200 */
            font-weight: 600;
            font-size: 0.95rem;
            box-shadow: var(--shadow-sm);
        }

        /* Forms */
        .form-group { margin-bottom: 1.5rem; }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.95rem;
        }

        .required-badge {
            background-color: var(--danger);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            vertical-align: middle;
            font-weight: bold;
        }

        input[type="text"],
        input[type="email"],
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            color: var(--text-main);
            background-color: var(--surface);
            transition: border-color 0.2s, box-shadow 0.2s;
            appearance: none;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-ring);
        }

        /* Buttons (Interaction Redundancy) */
        button.primary-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1.125rem;
            font-weight: 700;
            border-radius: 9999px; /* Pill shape */
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: var(--shadow-md);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        button.primary-btn:hover:not(:disabled) {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        button.primary-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        button.primary-btn:disabled {
            background-color: var(--text-muted);
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        button.secondary-btn {
            background-color: var(--text-muted);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            margin-top: 1rem;
            width: auto;
            display: inline-block;
        }

        /* Result Area Specifics (GAS Layout Port) */
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid var(--text-main);
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap; /* Mobile responsive */
        }

        .header-left-info {
            flex: 1;
            min-width: 200px;
        }

        .info-row { margin-bottom: 0.5rem; display: flex; align-items: baseline; }
        .info-label { width: 100px; color: var(--text-muted); font-size: 0.9rem; font-weight: 500; }
        .info-value { font-weight: 700; font-size: 1.1rem; }

        .header-right-ad {
            width: 200px;
            background-color: #fff1f2; /* Red-50 */
            border: 2px solid var(--danger);
            padding: 0.75rem;
            text-align: center;
            border-radius: var(--radius-md);
            flex-shrink: 0;
            margin: 0 auto; /* Center on mobile wrap */
        }

        .ad-title {
            font-size: 0.7rem;
            color: var(--danger);
            font-weight: 800;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .qr-placeholder {
            width: 80px; height: 80px;
            background-color: white;
            margin: 0 auto 0.5rem auto;
            display: flex; align-items: center; justify-content: center;
        }

        .ad-sub { font-size: 0.65rem; font-weight: 700; color: var(--text-main); }

        .intro-message {
            background: var(--background);
            padding: 0.75rem 1rem;
            border-left: 4px solid var(--text-main);
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }

        .checklist-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border: 2px solid var(--text-main);
        }
        .checklist-table th, .checklist-table td {
            border: 1px solid var(--text-main);
            padding: 0.75rem;
            text-align: left;
            font-size: 0.9rem;
            vertical-align: middle;
        }
        .checklist-table th { background-color: #f1f5f9; font-weight: 700; text-align: center; }
        .checklist-table .check-col { width: 60px; text-align: center; }
        
        .checkbox-square {
            display: inline-block;
            width: 18px; height: 18px;
            border: 2px solid var(--text-main);
            background: white;
            border-radius: 2px;
        }

        /* IAB Warning Modal (Existing) */
        #iab-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--radius-lg);
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow-lg);
        }
        .copy-box {
            display: flex; gap: 8px; margin-top: 1rem;
        }

        /* Image Save Modal (The "Ume" Plan - New) */
        #save-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); /* Darker backdrop for focus */
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            flex-direction: column;
        }
        .save-modal-content {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            max-width: 90vw;
            max-height: 85vh;
            width: 500px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .save-modal-header {
            margin-bottom: 1rem;
        }
        .save-modal-title {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.25rem;
            margin: 0 0 0.5rem 0;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .save-modal-desc {
            font-size: 0.9rem;
            color: var(--text-main);
            background: var(--info-bg);
            padding: 0.5rem;
            border-radius: 6px;
            font-weight: 600;
        }
        .save-image-wrapper {
            flex: 1;
            overflow-y: auto;
            margin: 0.5rem 0 1rem 0;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            background: #eee;
            position: relative;
        }
        .save-image-wrapper img {
            width: 100%;
            height: auto;
            display: block;
        }
        .close-modal-btn {
            background: var(--text-main);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 9999px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        /* PDF Specifics */
        .pdf-mode {
            padding: 0 !important; margin: 0 !important; background: white !important;
        }
        .pdf-mode .card {
            box-shadow: none !important; border: none !important; padding: 0 !important;
        }
        .pdf-mode .action-area { display: none !important; }

        /* Utility */
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="iab-modal">
        <div class="modal-content">
            <div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div>
            <h3>ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„</h3>
            <p class="text-muted">ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆInstagram/LINEç­‰ï¼‰ã§ã¯æ­£å¸¸ã«å‹•ä½œã—ã¾ã›ã‚“ã€‚</p>
            <p style="font-size:0.85rem; margin-bottom:1rem;">ä¸‹è¨˜URLã‚’ã‚³ãƒ”ãƒ¼ã—ã€Safari/Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚</p>
            <div class="copy-box">
                <input type="text" id="url-input" readonly style="width:100%; padding:0.5rem; border:1px solid var(--border); border-radius:4px; font-size:0.8rem;">
                <button onclick="copyUrl()" style="background:var(--text-main); color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; white-space:nowrap;">ã‚³ãƒ”ãƒ¼</button>
            </div>
        </div>
    </div>

    <div id="save-modal">
        <div class="save-modal-content">
            <div class="save-modal-header">
                <div class="save-modal-title">
                    <span>âœ¨ è¨ºæ–­æ›¸ä½œæˆå®Œäº†</span>
                </div>
                <div class="save-modal-desc">
                    ğŸ‘‡ ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã«ä¿å­˜ã€ã—ã¦ãã ã•ã„
                </div>
            </div>
            <div class="save-image-wrapper" id="save-image-container">
                </div>
            <button class="close-modal-btn" onclick="document.getElementById('save-modal').style.display='none'">
                é–‰ã˜ã‚‹
            </button>
        </div>
    </div>

    <div id="app" class="container">
        
        <div id="input-view" class="fade-in">
            <div class="save-guide">
                ğŸ“± è¨ºæ–­ã‚¹ã‚¿ãƒ¼ãƒˆ<br>
                <span style="font-weight:400; font-size:0.85rem;">æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</span>
            </div>

            <div class="card" style="border-top: 6px solid var(--primary);">
                <h1 class="title">ä»‹è­·æ–½è¨­ æ³•å®šç ”ä¿®è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
                <p class="subtitle">å¿…è¦ãªæ³•å®šç ”ä¿®ãƒªã‚¹ãƒˆã‚’1åˆ†ã§ä½œæˆã—ã¾ã™ã€‚</p>

                <form id="auditForm">
                    <div class="form-group">
                        <label>æ³•äººãƒ»æ–½è¨­å<span class="required-badge">å¿…é ˆ</span></label>
                        <input type="text" name="facilityName" placeholder="ä¾‹ï¼šæ ªå¼ä¼šç¤¾ã‚±ã‚¢ãƒ»ã‚µã‚¹ãƒ†ãƒŠãƒ–ãƒ« è¨ªå•ä»‹è­·ã‚µã‚¹ãƒ†ãƒŠ" required>
                    </div>

                    <div class="form-group">
                        <label>ä»£è¡¨è€…æ°å<span class="required-badge">å¿…é ˆ</span></label>
                        <input type="text" name="repName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ" required>
                    </div>

                    <div class="form-group">
                        <label>äº‹æ¥­å½¢æ…‹<span class="required-badge">å¿…é ˆ</span></label>
                        <select name="businessType" required>
                            <option value="" disabled selected>â–¼ é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="è¨ªå•ä»‹è­·">è¨ªå•ä»‹è­·</option>
                            <option value="è¨ªå•å…¥æµ´">è¨ªå•å…¥æµ´</option>
                            <option value="è¨ªå•çœ‹è­·">è¨ªå•çœ‹è­·</option>
                            <option value="è¨ªå•ãƒªãƒãƒ“ãƒª">è¨ªå•ãƒªãƒãƒ“ãƒª</option>
                            <option value="é€šæ‰€ä»‹è­·">é€šæ‰€ä»‹è­·</option>
                            <option value="é€šæ‰€ãƒªãƒãƒ“ãƒª">é€šæ‰€ãƒªãƒãƒ“ãƒª</option>
                            <option value="å±…å®…ä»‹è­·æ”¯æ´">å±…å®…ä»‹è­·æ”¯æ´</option>
                            <option value="ç¦ç¥‰ç”¨å…·è²¸ä¸">ç¦ç¥‰ç”¨å…·è²¸ä¸</option>
                            <option value="å°è¦æ¨¡å¤šæ©Ÿèƒ½">å°è¦æ¨¡å¤šæ©Ÿèƒ½</option>
                            <option value="èªçŸ¥ç—‡GH">èªçŸ¥ç—‡GH</option>
                            <option value="ç‰¹å®šæ–½è¨­å…¥å±…è€…ç”Ÿæ´»">ç‰¹å®šæ–½è¨­å…¥å±…è€…ç”Ÿæ´»</option>
                            <option value="ä»‹è­·è€äººç¦ç¥‰æ–½è¨­">ä»‹è­·è€äººç¦ç¥‰æ–½è¨­</option>
                            <option value="ä»‹è­·è€äººä¿å¥æ–½è¨­">ä»‹è­·è€äººä¿å¥æ–½è¨­</option>
                            <option value="ä»‹è­·åŒ»ç™‚é™¢">ä»‹è­·åŒ»ç™‚é™¢</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span class="required-badge">å¿…é ˆ</span></label>
                        <input type="email" name="email" placeholder="result@example.com" required>
                    </div>

                    <button type="submit" id="submitBtn" class="primary-btn">
                        <span>è¨ºæ–­ã—ã¦ãƒªã‚¹ãƒˆã‚’ä½œæˆ</span>
                    </button>
                </form>
            </div>
        </div>

        <div id="result-view" class="hidden fade-in">
            <div id="printable-area" class="card">
                <h1 id="pdf-title" class="text-center" style="font-size: 1.5rem; border-bottom: 2px solid var(--text-main); padding-bottom: 1rem; margin-bottom: 1.5rem;">æ³•å®šç ”ä¿®å®Ÿæ–½ãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆ</h1>
                
                <div class="header-container">
                    <div class="header-left-info">
                        <div class="info-row"><span class="info-label">æ–½è¨­å</span> <span class="info-value" id="out-facility"></span></div>
                        <div class="info-row"><span class="info-label">ä»£è¡¨è€…</span> <span class="info-value" id="out-rep"></span></div>
                        <div class="info-row"><span class="info-label">äº‹æ¥­å½¢æ…‹</span> <span class="info-value" id="out-type"></span></div>
                        <div class="info-row"><span class="info-label">ä½œæˆæ—¥</span> <span class="info-value" id="out-date"></span></div>
                    </div>
                    
                    <div class="header-right-ad">
                        <div class="ad-title">â–¼ ç ”ä¿®ãƒ»åŠ ç®—ã®ç„¡æ–™ç›¸è«‡ â–¼</div>
                        <div class="qr-placeholder">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://example.com" alt="QR" style="width:100%; height:100%;">
                        </div>
                        <div class="ad-sub">ã‚¹ãƒãƒ›ã§ãŠå•ã„åˆã‚ã›</div>
                    </div>
                </div>

                <p class="intro-message">
                    è²´äº‹æ¥­æ‰€ãŒå®Ÿæ–½ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„æ³•å®šç ”ä¿®ä¸€è¦§
                </p>
                
                <p class="text-muted" style="font-size: 0.8rem; margin-bottom: 1rem;">
                    â€»å›½ãŒå®šã‚ã‚‹æ³•å®šç ”ä¿®ã§ã™ã€‚æŒ‡å®šæ¨©è€…ï¼ˆè‡ªæ²»ä½“ï¼‰ã«ã‚ˆã‚Šè¿½åŠ ç ”ä¿®ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚å¿…ãšæ¡ä¾‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
                </p>

                <table class="checklist-table">
                    <thead>
                        <tr>
                            <th>ç ”ä¿®ãƒ—ãƒ­ã‚°ãƒ©ãƒ å†…å®¹</th>
                            <th style="width: 100px;">å®Ÿæ–½æ—¥</th>
                            <th class="check-col">ç¢ºèª</th>
                        </tr>
                    </thead>
                    <tbody id="checklist-body">
                        </tbody>
                </table>
            </div>

            <div class="action-area" style="text-align: center; margin-top: 2rem;">
                <button onclick="generatePDF()" id="pdfBtn" class="primary-btn" style="background-color: var(--danger); max-width: 320px; margin: 0 auto;">
                    ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
                <p class="text-muted" style="font-size: 0.8rem; margin-top: 1rem;">
                    â€»åå¿œãŒãªã„å ´åˆã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
                </p>
                <button onclick="location.reload()" class="secondary-btn">
                    æˆ»ã£ã¦åˆ¥ã®äº‹æ¥­æ‰€ã§ä½œæˆ
                </button>
            </div>
        </div>

    </div>

    <script>
        /**
         * =========================================
         * Configuration & Knowledge Base
         * =========================================
         */
        
        // â˜… EmailJS Configuration
        const EMAIL_CONFIG = {
            SERVICE_ID: 'service_06gngc6',
            TEMPLATE_ID: 'template_7sf7k1a',
            PUBLIC_KEY: 'mxhuhGFMNecoiqbLu'
        };

        // Training Logic Knowledge (Ported from GAS)
        const ALL_TYPES = [
            "è¨ªå•ä»‹è­·", "è¨ªå•å…¥æµ´", "è¨ªå•çœ‹è­·", "è¨ªå•ãƒªãƒãƒ“ãƒª", 
            "é€šæ‰€ä»‹è­·", "é€šæ‰€ãƒªãƒãƒ“ãƒª", "å±…å®…ä»‹è­·æ”¯æ´", "ç¦ç¥‰ç”¨å…·è²¸ä¸", 
            "å°è¦æ¨¡å¤šæ©Ÿèƒ½", "èªçŸ¥ç—‡GH", "ç‰¹å®šæ–½è¨­å…¥å±…è€…ç”Ÿæ´»", 
            "ä»‹è­·è€äººç¦ç¥‰æ–½è¨­", "ä»‹è­·è€äººä¿å¥æ–½è¨­", "ä»‹è­·åŒ»ç™‚é™¢"
        ];

        const TRAINING_DATA = [
            { name: "â‘  èªçŸ¥ç—‡ã€èªçŸ¥ç—‡ã‚±ã‚¢ã«é–¢ã™ã‚‹ç ”ä¿®", targets: "ALL" },
            { name: "â‘¡ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã«é–¢ã™ã‚‹ç ”ä¿®", targets: "ALL" },
            { name: "â‘¢ æ¥é‡ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ["è¨ªå•ä»‹è­·", "è¨ªå•å…¥æµ´"] },
            { name: "â‘£ å€«ç†ãƒ»æ³•ä»¤éµå®ˆã«é–¢ã™ã‚‹ç ”ä¿®", targets: "ALL" },
            { name: "â‘¤ äº‹æ•…ã®ç™ºç”Ÿã€äºˆé˜²ã€å†ç™ºé˜²æ­¢ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ALL_TYPES.filter(t => t !== "å±…å®…ä»‹è­·æ”¯æ´") },
            { name: "â‘¥ ç·Šæ€¥æ™‚ã®å¯¾å¿œã«é–¢ã™ã‚‹ç ”ä¿®", targets: ALL_TYPES.filter(t => t !== "å±…å®…ä»‹è­·æ”¯æ´") },
            { name: "â‘¦ æ„ŸæŸ“ç—‡åŠã³é£Ÿä¸­æ¯’ã®ç™ºç”ŸåŠã³è”“å»¶é˜²æ­¢ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ALL_TYPES.filter(t => t !== "å±…å®…ä»‹è­·æ”¯æ´") },
            { name: "â‘§ èº«ä½“æ‹˜æŸã®æ’é™¤ã®å–ã‚Šçµ„ã¿ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ALL_TYPES.filter(t => !["è¨ªå•ä»‹è­·", "è¨ªå•å…¥æµ´", "è¨ªå•ãƒªãƒãƒ“ãƒª", "å±…å®…ä»‹è­·æ”¯æ´"].includes(t)) },
            { name: "â‘¨ éå¸¸ç½å®³æ™‚ã®å¯¾å¿œã«é–¢ã™ã‚‹ç ”ä¿®", targets: "ALL" },
            { name: "â‘© ä»‹è­·äºˆé˜²åŠã³è¦ä»‹è­·ã®é€²è¡Œäºˆé˜²ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ["ç‰¹å®šæ–½è¨­å…¥å±…è€…ç”Ÿæ´»"] },
            { name: "â‘ª åŒ»ç™‚ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ["ä»‹è­·è€äººç¦ç¥‰æ–½è¨­"] },
            { name: "â‘« ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚±ã‚¢ï¼ˆçµ‚æœ«åŒ»ç™‚ï¼‰ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ["ä»‹è­·è€äººç¦ç¥‰æ–½è¨­", "ä»‹è­·åŒ»ç™‚é™¢"] },
            { name: "â‘¬ ç²¾ç¥çš„ã‚±ã‚¢ã«é–¢ã™ã‚‹ç ”ä¿®", targets: ["èªçŸ¥ç—‡GH", "ä»‹è­·è€äººç¦ç¥‰æ–½è¨­"] },
            { name: "â‘­ æ¥­å‹™ç¶™ç¶šè¨ˆç”»ï¼ˆBCPï¼‰", targets: "ALL" },
            { name: "â‘® ãƒãƒ©ã‚¹ãƒ¡ãƒ³ãƒˆå¯¾ç­–ãƒ»å¯¾å¿œ", targets: "ALL" },
            { name: "â‘¯ é«˜é½¢è€…è™å¾…é˜²æ­¢ã€é–¢é€£æ³•å«ã‚€è™å¾…é˜²æ­¢ã«é–¢ã™ã‚‹ç ”ä¿®", targets: "ALL" },
            { name: "â‘° çœ‹å–ã‚Šçœ‹è­·ã«é–¢ã™ã‚‹ç ”ä¿®ï¼ˆåŠ ç®—ç®—å®šæ™‚ãªã©ï¼‰", targets: ["èªçŸ¥ç—‡GH", "ç‰¹å®šæ–½è¨­å…¥å±…è€…ç”Ÿæ´»", "ä»‹è­·è€äººç¦ç¥‰æ–½è¨­"] }
        ];

        /**
         * =========================================
         * Resilience & Utility Patterns
         * =========================================
         */

        // 1. Initialize EmailJS
        // [Modified] ãƒ†ã‚¹ãƒˆç”¨ã®ãŸã‚ç„¡åŠ¹åŒ– (Emailæ©Ÿèƒ½ã®åœæ­¢)
        /*
        (function() {
            try {
                emailjs.init(EMAIL_CONFIG.PUBLIC_KEY);
            } catch(e) {
                console.warn("EmailJS Init Failed (Offline mode active):", e);
            }
        })();
        */

        // 2. IAB Detection & Copy Logic
        window.addEventListener('DOMContentLoaded', () => {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isIAB = (ua.indexOf('Instagram') > -1) || (ua.indexOf('FBAN') > -1) || (ua.indexOf('Line') > -1);
            
            if (isIAB) {
                const modal = document.getElementById('iab-modal');
                const input = document.getElementById('url-input');
                input.value = window.location.href;
                // Show IAB warning on start (optional, maybe distracting if we have fallback now)
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        });

        function copyUrl() {
            const copyText = document.getElementById("url-input");
            copyText.select();
            copyText.setSelectionRange(0, 99999);
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(copyText.value).then(() => alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„ã€‚"));
            } else {
                document.execCommand('copy');
                alert("URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã„ã¦ãã ã•ã„ã€‚");
            }
        }

        /**
         * =========================================
         * Application Logic
         * =========================================
         */
        
        const form = document.getElementById('auditForm');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. Interaction Redundancy (Manual Trigger)
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>è¨ºæ–­ä¸­...</span>';

            try {
                // 2. Collect Data
                const formData = new FormData(form);
                const data = {
                    facilityName: formData.get('facilityName'),
                    repName: formData.get('repName'),
                    businessType: formData.get('businessType'),
                    email: formData.get('email'),
                    date: new Date().toLocaleDateString('ja-JP')
                };

                // 3. Local Persistence (Safety Backup)
                try {
                    localStorage.setItem('last_audit_data', JSON.stringify(data));
                } catch(e) { console.warn("Storage failed", e); }

                // 4. Send Email (Optional/Async)
                // [Modified] ãƒ†ã‚¹ãƒˆç”¨ã®ãŸã‚ç„¡åŠ¹åŒ– (Emailé€ä¿¡ã®åœæ­¢)
                /*
                try {
                    await emailjs.send(
                        EMAIL_CONFIG.SERVICE_ID,
                        EMAIL_CONFIG.TEMPLATE_ID,
                        data
                    );
                } catch(emailError) {
                    console.error("Email send failed:", emailError);
                    // Continue flow even if email fails
                }
                */
                console.log("â€»ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸã€‚");

                // 5. Generate Logic
                renderResult(data);

                // 6. View Transition
                document.getElementById('input-view').classList.add('hidden');
                document.getElementById('result-view').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        function renderResult(data) {
            // Fill Headers
            document.getElementById('out-facility').innerText = data.facilityName;
            document.getElementById('out-rep').innerText = data.repName;
            document.getElementById('out-type').innerText = data.businessType;
            document.getElementById('out-date').innerText = data.date;

            // Generate List
            const tbody = document.getElementById('checklist-body');
            tbody.innerHTML = '';

            TRAINING_DATA.forEach(item => {
                let isTarget = false;
                if (item.targets === "ALL") {
                    isTarget = true;
                } else if (Array.isArray(item.targets) && item.targets.includes(data.businessType)) {
                    isTarget = true;
                }

                if (isTarget) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.name}</td>
                        <td></td>
                        <td class="check-col"><span class="checkbox-square"></span></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        // ========================================================
        // ğŸš€ æ¾ç«¹æ¢…ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼šWeb Share API -> Download -> Image Modal
        // ========================================================
        async function generatePDF() {
            const element = document.getElementById('printable-area');
            const btn = document.getElementById('pdfBtn');
            const originalText = btn.innerText;
            
            // 1. UI Feedback: Immediate Disable
            btn.disabled = true;
            btn.innerText = "ä½œæˆä¸­...";

            // Optimize for PDF/Image capture
            element.classList.add('pdf-mode');

            const timestamp = new Date().getTime();
            const filename = `æ³•å®šç ”ä¿®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ_${timestamp}.pdf`;

            const opt = {
                margin:       [10, 10, 10, 10],
                filename:     filename,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const ua = navigator.userAgent || navigator.vendor || window.opera;
            const isIAB = (ua.indexOf('Instagram') > -1) || (ua.indexOf('FBAN') > -1) || (ua.indexOf('Line') > -1);

            try {
                // ===========================================
                // ã€æ¾ã€‘Web Share API Try
                // ===========================================
                // ã¾ãšPDFã®Blobã‚’ç”Ÿæˆ
                const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
                const file = new File([pdfBlob], filename, { type: 'application/pdf' });

                // Share APIãƒã‚§ãƒƒã‚¯: ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰ãŒå¯èƒ½ã‹ï¼Ÿ
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'æ³•å®šç ”ä¿®è¨ºæ–­çµæœ',
                            text: 'è¨ºæ–­çµæœã®PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…±æœ‰ã—ã¾ã™ã€‚'
                        });
                        // å…±æœ‰æˆåŠŸã—ãŸã‚‰ã“ã“ã§çµ‚äº†
                        return;
                    } catch (shareError) {
                        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç­‰ã¯ç„¡è¦–ã€ã‚¨ãƒ©ãƒ¼ãªã‚‰æ¬¡ã¸
                        if (shareError.name !== 'AbortError') {
                            console.warn("Share API Failed:", shareError);
                        } else {
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã‚‰ä½•ã‚‚ã—ãªã„ã§çµ‚äº†
                            return; 
                        }
                    }
                }

                // ===========================================
                // ã€ç«¹ã€‘æ¨™æº–ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (PC / Android Chromeç­‰)
                // ===========================================
                // IABã§ãªã‘ã‚Œã°é€šå¸¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è©¦ã¿ã‚‹
                if (!isIAB) {
                    // Blobã‹ã‚‰URLã‚’ç”Ÿæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯ã•ã›ã‚‹ (html2pdf.save()ã ã¨å†ç”ŸæˆãŒèµ°ã‚‹ãŸã‚Blobæ´»ç”¨)
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a); // Firefoxå¯¾ç­–
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    return;
                }

                // ===========================================
                // ã€æ¢…ã€‘IABãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç”»åƒç”Ÿæˆï¼†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                // ===========================================
                // ã“ã“ã«æ¥ã‚‹ã®ã¯ã€ŒShare APIéå¯¾å¿œã€ã‹ã¤ã€ŒIABç’°å¢ƒã€ã®ã¿
                throw new Error("Fallback to Image");

            } catch (e) {
                // PDFç”Ÿæˆå¤±æ•—ã€ã¾ãŸã¯IABã§ã©ã†ã—ã‚ˆã†ã‚‚ãªã„å ´åˆ -> ç”»åƒä¿å­˜ã¸èª˜å°
                console.warn("PDF generation/download failed, falling back to Image mode.", e);
                await showImageModal(element, opt);

            } finally {
                element.classList.remove('pdf-mode');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        }

        async function showImageModal(element, opt) {
            try {
                // ç”»åƒ(DataURI)ã‚’ç”Ÿæˆ
                const imgData = await html2pdf().set(opt).from(element).toImg().output('datauristring');
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ç”»åƒã‚’ã‚»ãƒƒãƒˆ
                const container = document.getElementById('save-image-container');
                container.innerHTML = `<img src="${imgData}" alt="è¨ºæ–­çµæœ" />`;
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                document.getElementById('save-modal').style.display = 'flex';
                
            } catch (err) {
                alert("ç”»åƒã®ç”Ÿæˆã«ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã£ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
                console.error(err);
            }
        }
    </script>
</body>
</html>